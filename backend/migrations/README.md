# Database Migrations

This directory contains Alembic migration scripts for the AI Agent System database.

## Migration Overview

### 001_comprehensive_database_schema.py
**Complete database schema with all tables and relationships**

This migration creates the comprehensive database schema including:

#### Core Tables
- **users** - User accounts with roles, preferences, and budget management
- **conversations** - Chat conversations with AI configuration and analytics
- **messages** - Individual messages with metadata and costs
- **ai_requests** - Detailed tracking of all AI model requests with performance metrics
- **generated_content** - Track all content generated by AI (code, documents, media)

#### Analytics & Tracking Tables
- **cost_tracking** - Detailed cost tracking and analytics by period and model
- **user_budgets** - User budget management with alerts and thresholds
- **performance_metrics** - Enhanced system performance monitoring
- **system_alerts** - System alerts and notifications
- **audit_logs** - Comprehensive audit logging for security and compliance

#### Legacy Tables (maintained for compatibility)
- **usage_logs** - Basic usage tracking
- **ai_models** - Available AI models and pricing
- **agents** - AI agents with specific configurations
- **tasks** - Background tasks and scheduling
- **system_metrics** - Basic system metrics

## Running Migrations

### Prerequisites
```bash
pip install alembic
```

### Initialize Alembic (if not already done)
```bash
alembic init migrations
```

### Generate a new migration
```bash
alembic revision --autogenerate -m "Description of changes"
```

### Apply migrations
```bash
# Upgrade to latest
alembic upgrade head

# Upgrade to specific revision
alembic upgrade 001_comprehensive_schema

# Downgrade to previous revision
alembic downgrade -1

# Show current revision
alembic current

# Show migration history
alembic history
```

### Database Schema Features

#### Comprehensive Indexing
- **Performance indexes** on frequently queried columns
- **Composite indexes** for complex queries (user_id + created_at)
- **Unique indexes** for data integrity (UUIDs, usernames, emails)

#### Data Integrity
- **Foreign key constraints** maintaining referential integrity
- **Check constraints** ensuring data validity (positive costs, valid percentages)
- **Unique constraints** preventing duplicate records

#### Advanced Features
- **JSON columns** for flexible metadata storage
- **Enum types** for standardized categorical data
- **Timezone-aware timestamps** for global deployments
- **UUID columns** for external API integration
- **BigInteger columns** for large token counts

#### Budget Management
- **Multi-level budget tracking** (user-level and custom budgets)
- **Automated alerts** with configurable thresholds
- **Cost aggregation** by time periods and models
- **Budget utilization** tracking and reporting

#### Content Management
- **Version control** for generated content
- **File metadata** tracking (size, type, validation status)
- **Public/private** content sharing
- **Template system** for reusable content

#### Analytics & Monitoring
- **Request-level tracking** with full performance metrics
- **Cost optimization** data for model recommendations
- **System performance** monitoring with statistical aggregation
- **User behavior** tracking for insights

## Migration Best Practices

### Before Running Migrations
1. **Backup your database**
2. **Test migrations on development environment**
3. **Review generated SQL** for complex migrations
4. **Check for data consistency** after migration

### Production Deployment
1. **Schedule during maintenance window**
2. **Monitor migration progress**
3. **Verify data integrity** after completion
4. **Have rollback plan ready**

### Troubleshooting

#### Common Issues
- **Enum conflicts**: Drop and recreate enums if modified
- **Index conflicts**: Check for existing indexes before creating
- **Foreign key errors**: Ensure referenced tables exist
- **Permission errors**: Verify database user has DDL permissions

#### Recovery Commands
```bash
# Reset to specific revision
alembic downgrade 001_comprehensive_schema
alembic upgrade head

# Force revision (dangerous - use only if database is corrupted)
alembic stamp head
```

## Schema Documentation

### Relationships Overview
```
Users (1) -> (M) Conversations
Users (1) -> (M) AI_Requests  
Users (1) -> (M) Generated_Content
Users (1) -> (M) Cost_Tracking
Users (1) -> (M) User_Budgets

Conversations (1) -> (M) Messages
Conversations (1) -> (M) AI_Requests

AI_Requests (1) -> (M) Generated_Content
AI_Requests (1) -> (M) Cost_Tracking

Generated_Content (1) -> (M) Generated_Content (parent/child versions)
```

### Key Features by Table

#### Users Table
- **Authentication**: Username, email, hashed password
- **Authorization**: Role-based access control
- **Preferences**: Model preferences, temperature, timezone
- **Budget Management**: Monthly limits, current spend, alert settings
- **Security**: Failed login tracking, account lockout

#### AI_Requests Table
- **Request Tracking**: Full request/response lifecycle
- **Performance Metrics**: Response times, tokens per second
- **Cost Tracking**: Detailed cost breakdown by input/output
- **Quality Metrics**: Confidence, safety, relevance scores
- **User Feedback**: Ratings and comments

#### Generated_Content Table
- **Content Storage**: Text and binary content support
- **Metadata**: Language, framework, file information
- **Version Control**: Parent/child relationships, version tracking
- **Validation**: Syntax checking, execution status
- **Sharing**: Public/private access, download tracking

#### Cost_Tracking Table
- **Time Periods**: Hourly, daily, weekly, monthly, yearly aggregation
- **Model Breakdown**: Costs by provider and model
- **Performance Analytics**: Response times, success rates
- **Budget Integration**: Budget limits and utilization

## Data Migration Scripts

For migrating data from existing systems, see:
- `scripts/migrate_legacy_data.py` - Migrate from old schema
- `scripts/import_user_data.py` - Bulk user import
- `scripts/cleanup_old_data.py` - Clean up deprecated data

## Monitoring & Maintenance

### Regular Maintenance Tasks
1. **Archive old data** (>90 days for logs, >1 year for metrics)
2. **Reindex frequently updated tables**
3. **Update table statistics** for query optimization
4. **Monitor disk usage** for large JSON columns

### Performance Tuning
1. **Analyze query patterns** from logs
2. **Add indexes** for frequent queries
3. **Partition large tables** by date if needed
4. **Configure connection pooling** appropriately